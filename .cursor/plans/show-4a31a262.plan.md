<!-- 4a31a262-0f3e-49cd-a31b-948811b7bb22 770cbc71-c73a-449c-a101-0ae3f242689c -->
# Video fallback, backoff, and friendly error messages

## Scope

- Add video fallback logic similar to text: switch between Veo 2 and Aivideoauto when primary fails.
- Implement rate-limit backoff (429) for OpenAI and Gemini video/chat calls.
- Show toast when fallback triggers or when all providers exhausted.
- Replace raw JSON error on video cards with concise, localized messages (“Tạo video thất bại: <nguyên nhân>”).

## Files to change

- `hooks/useStoryboard.ts`: implement video fallback, map errors to user text, call `window.toast`.
- `services/veoService.ts`, `services/aivideoautoService.ts`: add error typing and unwrap messages; optional simple backoff helper.
- `components/storyboard/TimelinePreviewer.tsx` and/or `components/storyboard/StoryboardEditor.tsx`: ensure they show `videoStatusMessage` (plain text), not raw error object.
- (Optional) `services/openaiService.ts`, `services/geminiService.ts`: share backoff util for 429.

## Changes

1) Video fallback logic

- When service=openai:
- provider=google → try Veo; on error (4xx/5xx/timeout/credits) and Aivideoauto valid → fallback Aivideoauto with toast.
- provider=aivideoauto → try Aivideoauto; on error and Google ready → fallback Veo with toast.
- When service=google or aivideoauto:
- Try primary; on error and other provider ready → fallback with toast.
- If both fail → set `videoStatus='error'` and `videoStatusMessage` to friendly text.

2) Rate-limit backoff

- Generic `withBackoff(fn)` for 429: read `Retry-After` (or default 2s, 4s), max 2 retries.
- Apply to OpenAI chat (existing) and Veo where applicable.

3) Friendly error messages

- Add `mapVideoError(err)` that returns short Vietnamese messages:
- 429: “Quá giới hạn, vui lòng thử lại sau.”
- 401/403: “Key không hợp lệ hoặc bị từ chối.”
- Hết credits: “Tài khoản không đủ credits.”
- Model not found / 400: “Model không khả dụng.”
- Network: “Mạng lỗi hoặc máy chủ không phản hồi.”
- Use this for `videoStatusMessage` and toasts.

4) UI display

- Ensure failure tile shows:
- Title: “Tạo video thất bại”
- Subtitle: `videoStatusMessage` (plain text, no JSON)
- Keep the “Thử lại” button behavior.

## Test Plan

- OpenAI provider=Aivideoauto: simulate credits error → toast + fallback Veo (if Google ready).
- OpenAI provider=Google: simulate Veo model error → toast + fallback Aivideoauto.
- service=google and aivideoauto: primary fails → fallback opposite; if both fail → friendly error.
- 429 cases → backoff retries then fallback; verify toasts and messages.

## To-dos

- [ ] Implement video fallback (Veo↔Aivideoauto) in `useStoryboard.ts`
- [ ] Add backoff helper and apply to services
- [ ] Map errors to user-friendly Vietnamese texts
- [ ] Update UI to show friendly `videoStatusMessage`
- [ ] Tests: 429, 400 model, 401 invalid key, credits depleted, network errors

### To-dos

- [ ] Implement video fallback Veo↔Aivideoauto in useStoryboard
- [ ] Add 429 backoff helper and use in services
- [ ] Map errors to friendly Vietnamese texts for video
- [ ] Show friendly videoStatusMessage in UI instead of raw JSON
- [ ] Test fallback/backoff and messages across providers